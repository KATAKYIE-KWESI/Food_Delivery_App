{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - JollyFoods</title>
    <link rel="stylesheet" href="{% static 'driver_dashboard.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <header class="dashboard-header">
        <div class="header-content">
            <div class="logo-section">
                <i class="fa-solid fa-motorcycle"></i>
                <div>
                    <h1>JollyFoods</h1>
                    <p class="subtitle">Driver Dashboard</p>
                </div>
            </div>
            <div class="driver-profile">
                <div class="driver-info">
                    <span class="driver-name">{{ driver.name }}</span>
                    <span class="driver-status online">Online</span>
                </div>
                <div class="driver-avatar"><i class="fa-solid fa-user"></i></div>
            </div>
        </div>
    </header>

    <section class="stats-section">
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon deliveries"><i class="fa-solid fa-box"></i></div>
                <div class="stat-content"><h3>{{ deliveries|length }}</h3><p>New Orders</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon earnings"><i class="fa-solid fa-dollar-sign"></i></div>
                <div class="stat-content"><h3>GHS {{ total_earnings|default:"0.00" }}</h3><p>Today</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon rating"><i class="fa-solid fa-star"></i></div>
                <div class="stat-content"><h3>{{ driver_rating|default:"5.0" }}</h3><p>Rating</p></div>
            </div>
        </div>
    </section>

    <main class="main-content">
        <aside class="quick-actions">
            <h3>Menu</h3>
            <button class="action-btn"><i class="fa-solid fa-clock-rotate-left"></i> History</button>
            <button class="action-btn"><i class="fa-solid fa-chart-line"></i> Reports</button>
            <button class="action-btn" onclick="location.reload()"><i class="fa-solid fa-rotate"></i> Refresh Feed</button>

            <div class="availability-card" style="margin-top:20px;">
                <label class="switch">
                    <input type="checkbox" id="availabilityToggle" checked>
                    <span class="slider"></span>
                </label>
                <span class="status-text" style="font-size:13px; font-weight:600;">Available</span>
            </div>
        </aside>

        <div class="feed-area">
            <section class="my-deliveries-section" id="activeJobs">
                <div class="section-header">
                    <h2><i class="fa-solid fa-route"></i> My Active Jobs</h2>
                </div>
                <div class="deliveries-container" id="myDeliveriesContainer">
                    {% for d in my_jobs %}
                    <div class="delivery-card active-job" data-id="{{ d.id }}">
                        <div class="delivery-header">
                            <span class="order-number">#{{ d.order_id }}</span>
                            <div class="priority-badge normal">In Transit</div>
                        </div>
                        <div class="delivery-body">
                            <h4>{{ d.customer_name }}</h4>
                            <p><i class="fa-solid fa-location-dot"></i> {{ d.landmark }}</p>
                        </div>
                        <div class="delivery-actions" style="grid-template-columns: 1fr 1fr;">
                             <a href="https://www.google.com/maps/search/?api=1&query={{ d.lat }},{{ d.lon }}" target="_blank" class="action-btn-primary">
                                <i class="fa-solid fa-map"></i> View Map
                            </a>
                            <button class="action-btn-success" onclick="openTokenModal('{{ d.id }}')">
                                <i class="fa-solid fa-key"></i> Complete
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <p class="empty-msg" style="padding: 20px; color: #888;">No active jobs.</p>
                    {% endfor %}
                </div>
            </section>

            <section class="deliveries-section" style="margin-top:30px;">
                <div class="section-header">
                    <h2><i class="fa-solid fa-truck-fast"></i> New Deliveries</h2>
                </div>

                <div class="deliveries-container">
                    {% for d in deliveries %}
                    <div class="delivery-card" data-id="{{ d.id }}">
                        <div class="delivery-header">
                            <span class="order-number">#{{ d.order_id|default:forloop.counter }}</span>
                            <div class="priority-badge {{ d.priority|default:'normal' }}">
                                {{ d.priority|default:"Normal" }}
                            </div>
                        </div>
                        <div class="delivery-body">
                            <h4>{{ d.customer_name }}</h4>
                            <p><i class="fa-solid fa-location-dot"></i> {{ d.landmark|default:"Location provided" }}</p>

                            <div class="delivery-info">
                                <div class="info-item"><span class="label">Payment</span><span class="value">GHS {{ d.amount }}</span></div>
                                <div class="info-item"><span class="label">Dist</span><span class="value">{{ d.distance }}km</span></div>
                                <div class="info-item"><span class="label">Earn</span><span class="value" style="color:var(--success)">GHS {{ d.driver_earning }}</span></div>
                            </div>
                        </div>
                        <div class="delivery-actions">
                            <a href="https://www.google.com/maps/search/?api=1&query={{ d.lat }},{{ d.lon }}" target="_blank" class="action-btn-primary"><i class="fa-solid fa-map"></i></a>
                            <button class="action-btn-success" onclick="handleConfirmation('{{ d.id }}', 'accept')">Accept</button>
                            <button class="action-btn-danger" onclick="handleConfirmation('{{ d.id }}', 'decline')"><i class="fa-solid fa-times"></i></button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>
    </main>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content">
            <div id="modalIcon" style="font-size: 40px; margin-bottom: 10px;"></div>
            <h3 id="modalTitle">Confirm</h3>
            <p id="modalMessage" style="color: #666; margin: 10px 0; font-size: 14px;"></p>
            <div class="modal-btns">
                <button class="modal-btn" style="background:#eee; flex:1; padding:10px; border-radius:8px; border:none; cursor:pointer;" onclick="closeModals()">Cancel</button>
                <button class="modal-btn" id="modalConfirmBtn" style="color:white; flex:1; padding:10px; border-radius:8px; border:none; cursor:pointer;"></button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="tokenModal">
        <div class="modal-content">
            <div style="font-size: 40px; color: var(--primary); margin-bottom: 10px;">
                <i class="fa-solid fa-shield-halved"></i>
            </div>
            <h3>Verify Delivery</h3>
            <p style="color: #666; font-size: 13px;">Enter the 6-digit code from the customer.</p>
            <input type="text" id="tokenInput" class="token-input" maxlength="6" placeholder="000000" style="text-align:center; font-size:24px; padding:10px; width:80%; margin:15px 0; letter-spacing:5px;">
            <div class="modal-btns">
                <button class="modal-btn" style="background:#eee; flex:1; padding:10px; border-radius:8px; border:none; cursor:pointer;" onclick="closeModals()">Back</button>
                <button class="modal-btn" id="verifyTokenBtn" style="background:var(--success); color:white; flex:1; padding:10px; border-radius:8px; border:none; cursor:pointer;">Verify</button>
            </div>
        </div>
    </div>

   <script>
    const csrftoken = "{{ csrf_token }}";
    let currentId = null;
    let currentAction = null;

    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
    }

    // 1. Handle Acceptance of New Jobs
    function handleConfirmation(id, action) {
        currentId = id;
        currentAction = action;
        const modal = document.getElementById('confirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const btn = document.getElementById('modalConfirmBtn');

        if(action === 'accept') {
            icon.innerHTML = '<i class="fa-solid fa-circle-check" style="color:var(--success)"></i>';
            title.innerText = "Accept Delivery?";
            btn.innerText = "Accept";
            btn.style.background = "var(--success)";
        } else {
            icon.innerHTML = '<i class="fa-solid fa-circle-xmark" style="color:var(--danger)"></i>';
            title.innerText = "Hide Order?";
            btn.innerText = "Hide";
            btn.style.background = "var(--danger)";
        }
        modal.style.display = 'flex';
    }

  document.getElementById('modalConfirmBtn').onclick = function() {
    const card = document.querySelector(`.delivery-card[data-id="${currentId}"]`);

    if(currentAction === 'accept') {
        // Ensure this URL matches your urls.py (e.g., /driver/accept-delivery/ or /accept-delivery/)
        fetch(`/driver/accept-delivery/${currentId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                // 1. Remove from New Deliveries list
                card.remove();

                // 2. Update the internal HTML of the card for "Active" mode
                const actions = card.querySelector('.delivery-actions');
                actions.style.gridTemplateColumns = "1fr 1fr";

                // Use data.lng here as well!
                actions.innerHTML = `
                    <a href="https://www.google.com/maps/search/?api=1&query=${data.lat},${data.lng}" target="_blank" class="action-btn-primary">
                        <i class="fa-solid fa-map"></i> View Map
                    </a>
                    <button class="action-btn-success" onclick="openTokenModal('${currentId}')">
                        <i class="fa-solid fa-key"></i> Complete
                    </button>
                `;

                // 3. Update the status badge visually
                const badge = card.querySelector('.priority-badge');
                if(badge) {
                    badge.innerText = "In Transit";
                    badge.className = "priority-badge normal";
                }

                // 4. Prepend to Active Jobs container
                const activeContainer = document.getElementById('myDeliveriesContainer');

                // Clear the "No active jobs" message if it exists
                const emptyMsg = activeContainer.querySelector('.empty-msg');
                if(emptyMsg) emptyMsg.remove();

                activeContainer.prepend(card);

            } else {
                alert(data.error || "Could not accept delivery.");
            }
        });
    } else {
        card.remove();
    }
    closeModals();
};


    // 2. Handle Token Verification
    function openTokenModal(id) {
        currentId = id;
        document.getElementById('tokenInput').value = '';
        document.getElementById('tokenModal').style.display = 'flex';
    }

    document.getElementById('verifyTokenBtn').onclick = function() {
        const token = document.getElementById('tokenInput').value;
        if(token.length === 6) {
            // Updated to use the verify-token URL we created in views.py
            fetch(`/verify-token/${currentId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 'token': token })
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    alert("Order Verified & Completed!");
                    document.querySelector(`.delivery-card[data-id="${currentId}"]`).remove();
                    closeModals();
                    // Optionally refresh to update your earnings stat
                    location.reload();
                } else {
                    alert("Invalid Code: " + data.error);
                }
            });
        } else {
            alert("Please enter a 6-digit code.");
        }
    };

 // Initialize with the current count from the template .Checking for new deliveries without refreshing the page
let lastJobCount = {{ deliveries|length }};

function pollForJobs() {
    fetch('/check-new-jobs/')
        .then(response => response.json())
        .then(data => {
            // If the count on the server is higher than what we see, a new job arrived!
            if (data.count > lastJobCount) {
                console.log("New delivery found! Refreshing...");

                // Play a subtle notification sound (optional)
                // let audio = new Audio('{% static "sounds/notification.mp3" %}');
                // audio.play();

                // Refresh the feed
                location.reload();
            } else if (data.count < lastJobCount) {
                // Someone else grabbed a job, update the count without reloading
                lastJobCount = data.count;
            }
        })
        .catch(err => console.log("Polling error:", err));
}

// Check every 10 seconds
setInterval(pollForJobs, 10000);
</script>
</body>
</html>