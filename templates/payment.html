{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JollyFoods Checkout</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'payment.css' %}">
</head>
<body>

<div class="checkout-container">
    <div class="checkout-card">
        <div class="badge">
            <i class="fa-solid fa-shield-halved"></i> SECURE
        </div>

        <div class="logo">JollyFoods<span>.</span></div>
        <p class="tagline">Delicious moments, delivered with love</p>

        <!-- Order Items Preview -->
        <div class="order-items">
            <h3>
                <i class="fa-solid fa-receipt"></i>
                Your Order
            </h3>
            {% for item in cart_items %}
            <div class="item">
                <span class="item-name">
                    <i class="fa-solid fa-circle"></i>
                    {{ item.food_name }} (x{{ item.quantity }})
                </span>
                <span class="item-price">GHS {{ item.get_total_price }}</span>
            </div>
            {% endfor %}
        </div>

        <div class="order-summary">
            <div class="summary-row">
                <span>Subtotal</span>
                <span>GHS {{ subtotal }}</span>
            </div>
            <div class="summary-row">
                <span>Delivery Fee</span>
                <span>GHS {{ delivery_fee }}</span>
            </div>

            <div class="summary-divider"></div>

            <div class="total-row">
                <p>Total Amount</p>
                <h1>GHS {{ total_ghs|floatformat:2 }}</h1>
            </div>
        </div>

        <!-- Payment Methods -->
        <div class="payment-methods">
            <div class="payment-method active">
                <i class="fa-solid fa-credit-card"></i>
                <p>Card</p>
            </div>
            <div class="payment-method">
                <i class="fa-solid fa-mobile-screen-button"></i>
                <p>Mobile Money</p>
            </div>
            <div class="payment-method">
                <i class="fa-solid fa-building-columns"></i>
                <p>Bank</p>
            </div>
        </div>

        <!-- Pay Button -->
        <button type="button" class="pay-btn" onclick="payWithPaystack()">
            <i class="fa-solid fa-lock"></i> Pay Securely Now
        </button>

        <div class="loading">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>

        <!-- Security Badges -->
        <div class="security-badges">
            <div class="security-badge">
                <i class="fa-solid fa-shield-halved"></i>
                <span>SSL Encrypted</span>
            </div>
            <div class="security-badge">
                <i class="fa-solid fa-check-circle"></i>
                <span>PCI Compliant</span>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-icons">
            <i class="fa-solid fa-lock"></i>
            Secured by <strong>Paystack</strong>
        </div>

        <!-- Trust Indicators -->
        <div class="trust-indicators">
            <div class="trust-indicator">
                <i class="fa-solid fa-clock"></i>
                <span>Fast Delivery</span>
            </div>
            <div class="trust-indicator">
                <i class="fa-solid fa-rotate-left"></i>
                <span>Easy Returns</span>
            </div>
            <div class="trust-indicator">
                <i class="fa-solid fa-headset"></i>
                <span>24/7 Support</span>
            </div>
        </div>
    </div>
</div>


<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
    // Payment method selection
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', function() {
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Paystack payment
    function payWithPaystack() {
        let handler = PaystackPop.setup({
            key: '{{ paystack_public_key }}',
            amount: {{ paystack_amount }}, // in pesewas
            email: '{{ request.user.email|default:"customer@jollyfoods.com" }}',
            currency: 'GHS',
            ref: 'JF_' + Math.floor((Math.random() * 1000000000) + 1),
            callback: function(response) {
                // Payment succeeded âœ… inform backend
                fetch("{% url 'payment' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ paid: true })
                })
                .then(res => {
                    // Redirect to cart after backend sets session
                    window.location.href = "{% url 'cart' %}";
                })
                .catch(err => {
                    alert("Payment succeeded but server failed to update. Try refreshing cart.");
                    console.error(err);
                    window.location.href = "{% url 'cart' %}";
                });
            },
            onClose: function() {
                alert('Payment window closed.');
            }
        });
        handler.openIframe();
    }
</script>


</body>
</html>
