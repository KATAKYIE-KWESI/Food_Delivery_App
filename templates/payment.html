{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Checkout - JollyFoods</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'payment.css' %}">
</head>
<body>

<div class="checkout-container">
    <div class="header-actions">
        <a href="{% url 'homepage' %}" class="home-button">
            <i class="fa-solid fa-arrow-left"></i>
            <i class="fa-solid fa-house"></i>
            <span>Back to Home</span>
        </a>
    </div>

    <div class="checkout-card">
        <div class="badge">
            <i class="fa-solid fa-shield-halved"></i> SECURE
        </div>

        <div class="logo">JollyFoods<span>.</span></div>
        <p class="tagline">Delicious moments, delivered with love</p>

        <div class="order-items">
            <h3>
                <i class="fa-solid fa-receipt"></i>
                Your Order
            </h3>
            {% for item in cart_items %}
            <div class="item">
                <span class="item-name">
                    <i class="fa-solid fa-circle"></i>
                    {{ item.food_name }} (x{{ item.quantity }})
                </span>
                <span class="item-price">GHS {{ item.get_total_price }}</span>
            </div>
            {% endfor %}
        </div>

        <div class="order-summary">
            <div class="summary-row">
                <span>Subtotal</span>
                <span>GHS {{ subtotal }}</span>
            </div>
            <div class="summary-row">
                <span>Delivery Fee</span>
                <span>GHS {{ delivery_fee }}</span>
            </div>

            <div class="summary-divider"></div>

            <div class="total-row">
                <p>Total Amount</p>
                <h1>GHS {{ total_ghs|floatformat:2 }}</h1>
            </div>
        </div>

        <div class="payment-methods">
            <div class="payment-method active">
                <i class="fa-solid fa-credit-card"></i>
                <p>Card</p>
            </div>
            <div class="payment-method">
                <i class="fa-solid fa-mobile-screen-button"></i>
                <p>MoMo</p>
            </div>
        </div>

        <button type="button" class="pay-btn" id="mainPayBtn" onclick="payWithPaystack()">
            <i class="fa-solid fa-lock"></i> Pay Securely Now
        </button>

        <div class="security-badges">
            <div class="security-badge">
                <i class="fa-solid fa-shield-halved"></i>
                <span>SSL Encrypted</span>
            </div>
            <div class="security-badge">
                <i class="fa-solid fa-check-circle"></i>
                <span>Verified</span>
            </div>
        </div>

        <div class="footer-icons">
            <i class="fa-solid fa-lock"></i>
            Secured by <strong>Paystack</strong>
        </div>
    </div>
</div>



<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
    // 1. Payment method selection UI (Preserving your original logic)
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', function() {
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // 2. CSRF Token Utility (Preserving your original logic)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // 3. Main Paystack Function (Updated with Metadata for Phone)
    function payWithPaystack() {
        let handler = PaystackPop.setup({
            key: '{{ paystack_public_key }}',
            email: '{{ request.user.email|default:"customer@jollyfoods.com" }}',
            amount: {{ paystack_amount }},
            currency: 'GHS',
            ref: 'JF_' + Math.floor((Math.random() * 1000000000) + 1),

            // Adding Metadata ensures the phone number is tied to the Paystack transaction
            metadata: {
                custom_fields: [
                    {
                        display_name: "Phone Number",
                        variable_name: "phone_number",
                        value: "{{ request.user.profile.phone_number|default:'' }}"
                    }
                ]
            },

            callback: function(response) {
                // When payment is successful, ping the Django view
                fetch("{% url 'payment' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        reference: response.reference
                        // Note: Python's payment view handles phone/landmark via Session/Profile
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        // Redirect to the success state in cart
                        window.location.href = "{% url 'cart' %}";
                    } else {
                        alert("Order processing failed: " + data.error);
                    }
                })
                .catch(err => {
                    console.error("Fetch Error:", err);
                    alert("A network error occurred. Please contact support.");
                });
            },
            onClose: function() {
                alert('Transaction cancelled.');
            }
        });
        handler.openIframe();
    }
</script>
</body>
</html>